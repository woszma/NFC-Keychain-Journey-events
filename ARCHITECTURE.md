# NFC Keychain Journey - Phase 1 æ¶æ§‹èˆ‡æ•´åˆæŒ‡å—

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä½¿ç”¨è€…ç€è¦½å™¨                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  React App (Vite)                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ é é¢å…ƒä»¶ (Pages)                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - JourneyPage                                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - BlessingListPage                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - SharePage (Phase 2)                         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ UI å…ƒä»¶ (Components)                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - BlessingForm.tsx (åŠŸèƒ½ A)                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - BlessingCard.tsx                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - ReportMenu.tsx                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - ElephantReaction.tsx (åŠŸèƒ½ D)                â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ React Hooks (API æ•´åˆ)                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - useCreateBlessing()                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - useGetBlessings()                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - useGetReaction()                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - useCreateReport()                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - usePIIDetection() â† PII å®¢æˆ¶ç«¯æª¢æ¸¬            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - useCharacterCount()                         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ API å±¤ (lib/api.types.ts)                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - CreateBlessingRequest                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - BlessingResponse                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - ReactionResponse                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - ErrorResponse                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - Validation Rules                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - PII Patterns                                â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Supabase å®¢æˆ¶ç«¯                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (lib/supabaseClient.ts)                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - createBlessing()                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - getBlessings()                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - createReport()                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - getActiveReactions()                        â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                      â”‚
           â”‚ fetch() è«‹æ±‚                          â”‚ Supabase JS SDK
           â”‚                                      â”‚
           â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Express API ä¼ºæœå™¨                 â”‚  â”‚  Supabase            â”‚
â”‚    (http://localhost:3000)            â”‚  â”‚  (PostgreSQL DB)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è·¯ç”±å±¤ (routes/routes.ts)       â”‚  â”‚  â”‚  â”‚ è³‡æ–™è¡¨          â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚ POST /api/blessings            â”‚â—„â”€â”¼â”€â–º  â”‚ â”‚ keychains    â”‚â”‚  â”‚
â”‚  â”‚ GET /api/blessings             â”‚  â”‚  â”‚  â”‚ â”‚ blessings    â”‚â”‚  â”‚
â”‚  â”‚ PATCH /api/blessings/:id/hide  â”‚  â”‚  â”‚  â”‚ â”‚ reports      â”‚â”‚  â”‚
â”‚  â”‚ POST /api/reports              â”‚  â”‚  â”‚  â”‚ â”‚ elephant_    â”‚â”‚  â”‚
â”‚  â”‚ GET /api/reactions             â”‚  â”‚  â”‚  â”‚ â”‚ reactions    â”‚â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚  â”‚ â”‚ prompts      â”‚â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚ â”‚ events       â”‚â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚ â”‚ feedback     â”‚â”‚  â”‚
â”‚  â”‚ æ¥­å‹™é‚è¼¯å±¤                       â”‚  â”‚  â”‚  â”‚ â”‚ share_events â”‚â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â”‚ - PII Validation Middleware    â”‚  â”‚  â”‚  â”‚                â”‚  â”‚
â”‚  â”‚   (regex patterns + NLP)       â”‚  â”‚  â”‚  â”‚                â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚  â”‚ ç´¢å¼•:           â”‚  â”‚
â”‚  â”‚ - Rate Limiter Middleware      â”‚  â”‚  â”‚  â”‚ - blessings    â”‚  â”‚
â”‚  â”‚   (3 req / 5 min)             â”‚  â”‚  â”‚  â”‚   (keychain_id)â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚  â”‚ - elephant_    â”‚  â”‚
â”‚  â”‚ - Deterministic Hash Generator â”‚  â”‚  â”‚  â”‚   reactions    â”‚  â”‚
â”‚  â”‚   (seed = hash(journey + stn))â”‚  â”‚  â”‚  â”‚   (status)     â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚  â”‚                â”‚  â”‚
â”‚  â”‚ - Error Handler                â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚   (JSON error responses)       â”‚  â”‚  â”‚                      â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚ è¡Œç´šå®‰å…¨æ€§ (RLS):     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ - ç¥ç¦: åƒ…å…è¨±è®€å–    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   is_hidden=false    â”‚
â”‚  â”‚ è³‡æ–™åº«å±¤ (Supabase SDK)         â”‚  â”‚  â”‚ - å ±å‘Š: åƒ…ç®¡ç†å“¡ç®¡ç†  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚                      â”‚
â”‚  â”‚ - createBlessing()             â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚ - getBlessings()               â”‚  â”‚
â”‚  â”‚ - hideBlessing()               â”‚  â”‚
â”‚  â”‚ - createReport()               â”‚  â”‚
â”‚  â”‚ - getActiveReactions()         â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ æ–‡ä»¶æ˜ å°„

### æ ¸å¿ƒ API å±¤

| æª”æ¡ˆ | ç”¨é€” | ä½¿ç”¨æ–¹ |
|------|------|--------|
| `lib/api.types.ts` | TypeScript å‹åˆ¥å®šç¾© (API å¥‘ç´„) | å‰ç«¯ + å¾Œç«¯ |
| `openapi-phase1.json` | OpenAPI 3.0 è¦æ ¼æ–‡ä»¶ | API æ–‡ä»¶ + Swagger UI |

### å‰ç«¯å±¤

| æª”æ¡ˆ | ç”¨é€” | åŠŸèƒ½ |
|------|------|------|
| `components/BlessingForm.tsx` | ç¥ç¦æäº¤è¡¨å–® | åŠŸèƒ½ A æ ¸å¿ƒ UI |
| `lib/hooks/useAPI.ts` | React Hooks | å‰ç«¯ API å‘¼å«æ•´åˆ |
| `lib/supabaseClient.ts` | Supabase åŒ…è£å±¤ | ç›´æ¥è³‡æ–™åº«æ“ä½œ |

### å¾Œç«¯å±¤

| æª”æ¡ˆ | ç”¨é€” | åŠŸèƒ½ |
|------|------|------|
| `routes/routes.ts` | Express è·¯ç”±æ¡†æ¶ | æ‰€æœ‰ 6 å€‹ API ç«¯é» |
| `supabase_schema.sql` | è³‡æ–™åº«æ¶æ§‹ | 8 å€‹è¡¨çš„ DDL |

### æ–‡ä»¶èˆ‡ç¯„ä¾‹

| æª”æ¡ˆ | å…§å®¹ |
|------|------|
| `API_USAGE_EXAMPLES.md` | 10 å€‹ React/cURL/TypeScript ä½¿ç”¨ç¯„ä¾‹ |
| `DEVELOPMENT_GUIDE.ts` | ç’°å¢ƒè¨­å®š + æ•…éšœæ’é™¤ |
| `QUICKSTART_ZH.md` | å¿«é€Ÿé–‹å§‹æŒ‡å—ï¼ˆä¸­æ–‡ï¼‰ |

---

## ğŸ”„ è³‡æ–™æµç¨‹

### å ´æ™¯ 1: ä½¿ç”¨è€…æäº¤ç¥ç¦

```
1. ä½¿ç”¨è€…å¡«å¯« BlessingForm
   â”œâ”€ è¼¸å…¥: blessing_text, code_phrase, optional_note
   â”œâ”€ å®¢æˆ¶ç«¯ PII æª¢æ¸¬ (usePIIDetection)
   â””â”€ æŒ‰ä¸‹æäº¤

2. React Hook: useCreateBlessing()
   â”œâ”€ é©—è­‰è¡¨å–®è³‡æ–™ (Zod schema)
   â”œâ”€ æª¢æ¸¬ PII (regex patterns)
   â”œâ”€ å»ºç«‹ CreateBlessingRequest
   â””â”€ ç™¼é€ POST /api/blessings

3. Express å¾Œç«¯è™•ç†
   â”œâ”€ æ¥æ”¶è«‹æ±‚
   â”œâ”€ rateLimitMiddleware æª¢æŸ¥
   â”‚  â””â”€ è‹¥è¶…é 3 req/5 min â†’ å›å‚³ 429 RATE_LIMIT_EXCEEDED
   â”œâ”€ é©—è­‰å¿…å¡«æ¬„ä½
   â”‚  â””â”€ è‹¥ç¼ºå°‘ â†’ å›å‚³ 400 VALIDATION_ERROR
   â”œâ”€ æª¢é©—å­—æ•¸é™åˆ¶
   â”‚  â””â”€ è‹¥è¶…é â†’ å›å‚³ 400 VALIDATION_ERROR
   â”œâ”€ ä¼ºæœç«¯ PII é©—è­‰ (regex patterns)
   â”‚  â””â”€ è‹¥æª¢æ¸¬åˆ° â†’ å›å‚³ 400 PII_DETECTED
   â””â”€ å¯«å…¥ Supabase blessings è¡¨
      â”œâ”€ supabase.from('blessings').insert([...])
      â””â”€ å›å‚³ 201 BlessingResponse

4. å‰ç«¯æ¥æ”¶å›æ‡‰
   â”œâ”€ è‹¥ 201 â†’ é¡¯ç¤ºæˆåŠŸè¨Šæ¯
   â”‚  â””â”€ åŸ·è¡Œ onSuccess callback
   â”œâ”€ è‹¥ 400 â†’ é¡¯ç¤ºå…·é«”éŒ¯èª¤
   â”‚  â””â”€ æç¤ºä½¿ç”¨è€…ä¿®æ­£
   â””â”€ è‹¥ 429 â†’ æç¤ºç¨å¾Œé‡è©¦
```

### å ´æ™¯ 2: ä½¿ç”¨è€…æŸ¥çœ‹å°å°‡å›æ‡‰

```
1. é é¢åŠ è¼‰æ™‚å‘¼å« useGetReaction
   â”œâ”€ åƒæ•¸: { journey_id, station_number }
   â””â”€ ç™¼é€ GET /api/reactions?journey_id=...&station_number=...

2. Express å¾Œç«¯è™•ç†
   â”œâ”€ æ¥æ”¶æŸ¥è©¢åƒæ•¸
   â”œâ”€ é©—è­‰ journey_id, station_number å­˜åœ¨
   â”‚  â””â”€ è‹¥ç¼ºå°‘ â†’ å›å‚³ 400 VALIDATION_ERROR
   â”œâ”€ æŸ¥è©¢ Supabase elephant_reactions è¡¨
   â”‚  â””â”€ å–å¾—æ‰€æœ‰ status='active' çš„å¥å­
   â”œâ”€ ç”¢ç”Ÿç¢ºå®šæ€§é›œæ¹Š
   â”‚  â”œâ”€ seed = hash(journey_id + station_number)
   â”‚  â””â”€ ç¢ºä¿åŒä¸€çµ„åˆå§‹çµ‚å›å‚³ç›¸åŒçµæœ
   â”œâ”€ é¸æ“‡å¥å­: reactions[seed % total_count]
   â””â”€ å›å‚³ 200 ReactionResponse (åŒ…å« seed)

3. å‰ç«¯é¡¯ç¤º
   â”œâ”€ ElephantReactionComponent æ¥æ”¶å›æ‡‰
   â”œâ”€ é¡¯ç¤º reaction_text
   â”œâ”€ é¡¯ç¤ºåˆ†é¡èˆ‡æƒ…æ„Ÿé¡å‹
   â””â”€ ï¼ˆå¯é¸ï¼‰ä¿å­˜ seed ä¾›åˆ†äº«æ™‚ä½¿ç”¨

ğŸ’¡ é—œéµ: ç¢ºå®šæ€§é›œæ¹Šç¢ºä¿è·¨è£ç½®ä¸€è‡´æ€§
   - é›»è©±ç”¨æˆ¶çœ‹åˆ°çš„å¥å­ = ç¶²é ç”¨æˆ¶çœ‹åˆ°çš„å¥å­
   - æ˜å¹´æŸ¥çœ‹åŒä¸€ç«™é» = å»å¹´çœ‹åˆ°çš„ç›¸åŒå¥å­
```

### å ´æ™¯ 3: ä½¿ç”¨è€…èˆ‰å ±ç¥ç¦

```
1. ä½¿ç”¨è€…é»æ“Šèˆ‰å ±æŒ‰éˆ•
   â”œâ”€ é¸æ“‡èˆ‰å ±åŸå›  (PII_EXPOSED, INAPPROPRIATE, SPAM, OTHER)
   â””â”€ ç™¼é€ POST /api/reports

2. Express å¾Œç«¯è™•ç†
   â”œâ”€ é©—è­‰ blessing_id èˆ‡ reason
   â”œâ”€ å¯«å…¥ Supabase reports è¡¨
   â””â”€ å›å‚³ 201 ReportResponse

3. ï¼ˆå¯é¸ï¼‰è§¸ç™¼å·¥ä½œæµ
   â”œâ”€ è‹¥åŸå›  = PII_EXPOSED â†’ ç«‹å³æ¨™è¨˜ç¥ç¦ç‚º is_hidden=true
   â”œâ”€ è‹¥èˆ‰å ±æ•¸ > 3 â†’ è‡ªå‹•éš±è—ç¥ç¦
   â””â”€ é€šçŸ¥ç®¡ç†å“¡ (Slack / Email)
```

---

## ğŸ”— API å¥‘ç´„ (OpenAPI ä¸€è‡´æ€§)

### æ¯å€‹ç«¯é»çš„å®Œæ•´æµç¨‹

#### âœ… POST /api/blessings

```
è«‹æ±‚:
{
  "keychain_id": "journey-123",        # å¿…å¡«
  "blessing_text": "ç¥ç¦",              # å¿…å¡«, 1-15 å­—
  "code_phrase": "æš—èª",                # å¿…å¡«, 1-10 å­—
  "optional_note": "å‚™è¨»",              # å¯é¸, 0-120 å­—
  "station_number": 1,                 # å¯é¸, é è¨­ 1
  "visibility": "public"               # å¯é¸, é è¨­ "public"
}

å›æ‡‰ (201 Created):
{
  "id": 1,
  "keychain_id": "journey-123",
  "blessing_text": "ç¥ç¦",
  "code_phrase": "æš—èª",
  "optional_note": "å‚™è¨»",
  "station_number": 1,
  "visibility": "public",
  "is_hidden": false,
  "created_at": "2024-01-15T10:30:00Z"
}

éŒ¯èª¤ (400):
{
  "error": "PII_DETECTED",
  "message": "åµæ¸¬åˆ°å€‹äººèº«ä»½è³‡è¨Š",
  "detected_patterns": ["phone_hk", "email"]
}

éŒ¯èª¤ (429):
{
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "è¶…éé€Ÿç‡é™åˆ¶",
  "retry_after": 240  # ç§’æ•¸
}
```

#### âœ… GET /api/reactions

```
æŸ¥è©¢:
GET /api/reactions?journey_id=journey-123&station_number=1

å›æ‡‰ (200):
{
  "id": 42,
  "reaction_text": "ä½ çš„ç¥ç¦å·²è¢«è¨˜éŒ„åœ¨å†’éšªçš„æ•…äº‹ä¸­...",
  "category": "Blessing",
  "emotion_type": "Ritual",
  "seed": 12345678,  # ç”¨æ–¼é©—è­‰ä¸€è‡´æ€§
  "journey_id": "journey-123",
  "station_number": 1
}

ğŸ’¡ seed å€¼ç”¨é€”:
   - é©—è­‰ç¢ºå®šæ€§: è‹¥ seed ç›¸åŒ â†’ å¥å­ç›¸åŒ
   - ç”¨æ–¼ Phase 2ï¼ˆåˆ†äº«å¡æœƒç”¨åˆ°ç›¸åŒ seed ç”¢ç”Ÿ ResonanceLineï¼‰
   - ç”¨æ–¼èª¿è©¦ï¼šé–‹ç™¼è€…å¯æ ¹æ“š seed é‡ç¾ç›¸åŒå¥å­
```

---

## ğŸ”‘ é—œéµè¨­è¨ˆæ±ºç­–

### 1ï¸âƒ£ ç¢ºå®šæ€§éš¨æ©ŸåŒ– (Deterministic Randomness)

**å•é¡Œ**: ä¸åŒå¹³å°/è£ç½®çš„ä½¿ç”¨è€…çœ‹åˆ°çš„å¥å­è¦ä¸€è‡´

**è§£æ±º**:
```typescript
seed = hash(journey_id + station_number)
selectedIndex = seed % totalReactions
selectedReaction = reactions[selectedIndex]
```

**æ•ˆæœ**:
- âœ… åŒä¸€æ—…ç¨‹+ç«™é» â†’ æ°¸é ç›¸åŒå¥å­
- âœ… è·¨å¹³å°ä¸€è‡´æ€§ï¼ˆæ‰‹æ©Ÿã€ç¶²é ã€QR ç¢¼åˆ†äº«ï¼‰
- âœ… ç„¡é ˆå„²å­˜ç”¨æˆ¶-å¥å­å°æ‡‰

### 2ï¸âƒ£ é›™å±¤ PII é©—è­‰

**å®¢æˆ¶ç«¯** (useAPI.ts ä¸­çš„ usePIIDetection):
```typescript
- å³æ™‚é¡¯ç¤ºè­¦å‘Š
- ç¦ç”¨æäº¤æŒ‰éˆ•
- è‰¯å¥½ UX
```

**ä¼ºæœç«¯** (routes/routes.ts):
```typescript
- é˜²æ­¢ç›´æ¥ API å‘¼å«ç¹é
- æª¢æ¸¬è¤‡é›œæ¨¡å¼
- å®‰å…¨æ€§ä¿éšœ
```

### 3ï¸âƒ£ é€Ÿç‡é™åˆ¶

**å¯¦ç¾**: è¨˜æ†¶é«”ä¸­çš„ç°¡å–®è¨ˆæ•¸ (é–‹ç™¼)

```typescript
rateLimitStore.get(clientIp)
// { count: 1, resetTime: now + 5min }
```

**ç”Ÿç”¢å‡ç´š**: æ”¹ç”¨ Redis

```typescript
redis.incr(`rate_limit:${clientIp}`)
redis.expire(`rate_limit:${clientIp}`, 300)
```

### 4ï¸âƒ£ å¥å­åº«ç®¡ç†

**å„²å­˜ä½ç½®**: `elephant_reactions` Supabase è¡¨

**çµæ§‹**:
```sql
id: serial
reaction_text: text (â‰¤50 å­—)
category: enum (Blessing, Encouragement, Resonance, Ritual)
emotion_type: enum (Emotion, Ritual, Gratitude)
status: enum (active, inactive)
created_at: timestamp
```

**æ›´æ–°æµç¨‹**:
1. æ¯æœˆæ”¶é›†ä½¿ç”¨è€…åé¥‹ (from reports + feedback tables)
2. æ–°å¢ 10-20 å€‹æ–°å¥å­ (via admin API)
3. èˆŠå¥å­è¨­ç‚º inactive (ç„¡é ˆåˆªé™¤)
4. è‡ªå‹•å– active å¥å­é€²è¡Œç¢ºå®šæ€§é¸æ“‡

---

## ğŸš¦ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### å‰ç«¯éƒ¨ç½² (GitHub Pages / Vercel)

- [ ] `npm run build` ç„¡éŒ¯èª¤
- [ ] `VITE_SUPABASE_URL` è¨­å®šç‚ºç”Ÿç”¢ URL
- [ ] `REACT_APP_API_BASE_URL` è¨­å®šç‚º API ä¼ºæœå™¨ URL (HTTPS)
- [ ] CORS åœ¨ç€è¦½å™¨ä¸»æ§å°ç„¡éŒ¯èª¤
- [ ] æ‰€æœ‰ API å‘¼å«ä½¿ç”¨ HTTPS

### å¾Œç«¯éƒ¨ç½² (Vercel / Railway / Heroku)

- [ ] `npm run build` ç„¡éŒ¯èª¤
- [ ] æ‰€æœ‰ç’°å¢ƒè®Šæ•¸å·²è¨­å®š
- [ ] `SUPABASE_URL` å’Œ `SUPABASE_ANON_KEY` æ­£ç¢º
- [ ] `PORT` ç”±ç’°å¢ƒè®Šæ•¸è¨­å®š (å¦‚ `process.env.PORT || 3000`)
- [ ] CORS å…è¨±ç”Ÿç”¢å‰ç«¯åŸŸå
- [ ] æ—¥èªŒè¼¸å‡ºåˆ°æ¨™æº–è¼¸å‡º (docker-friendly)

### è³‡æ–™åº«éƒ¨ç½²

- [ ] `supabase_schema.sql` å·²åœ¨ç”Ÿç”¢ç’°å¢ƒåŸ·è¡Œ
- [ ] æ‰€æœ‰ 8 å€‹è¡¨å­˜åœ¨
- [ ] `elephant_reactions` è‡³å°‘æœ‰ 50 å€‹å¥å­
- [ ] å¤–éµç´„æŸå·²å•Ÿç”¨
- [ ] ç´¢å¼•å·²å»ºç«‹
- [ ] RLS (Row Level Security) å·²è¨­å®š

---

## ğŸ“ æ•´åˆæ”¯æ´

è‹¥é‡åˆ°æ•´åˆå•é¡Œï¼ŒæŒ‰é †åºæª¢æŸ¥ï¼š

1. **å¾Œç«¯ä¼ºæœå™¨å¥åº·æª¢æŸ¥**
   ```bash
   curl http://localhost:3000/health
   # æ‡‰è¿”å› {status: 'ok'}
   ```

2. **å‰ç«¯ç’°å¢ƒè®Šæ•¸æª¢æŸ¥**
   ```bash
   console.log(import.meta.env.VITE_SUPABASE_URL)
   # æ‡‰æœ‰å€¼
   ```

3. **Supabase é€£æ¥æª¢æŸ¥**
   ```bash
   # åœ¨å¾Œç«¯åŸ·è¡Œ
   supabase.from('blessings').select('count(*)')
   # æ‡‰æœ‰å›æ‡‰ï¼Œç„¡é€£æ¥éŒ¯èª¤
   ```

4. **CORS æª¢æŸ¥**
   ```bash
   # åœ¨ç€è¦½å™¨ DevTools ä¸­æŸ¥çœ‹ Network æ¨™ç±¤
   # å›æ‡‰æ‡‰åŒ…å« Access-Control-Allow-Origin header
   ```

5. **é€Ÿç‡é™åˆ¶æª¢æŸ¥**
   ```bash
   # å¿«é€Ÿé€£é€ 4 å€‹è«‹æ±‚
   curl -X POST http://localhost:3000/api/blessings ...  # 1
   curl -X POST http://localhost:3000/api/blessings ...  # 2
   curl -X POST http://localhost:3000/api/blessings ...  # 3
   curl -X POST http://localhost:3000/api/blessings ...  # 4 - æ‡‰è¿”å› 429
   ```

---

## ğŸ“ æ¶æ§‹å­¸ç¿’è·¯å¾‘

æ¨è–¦å­¸ç¿’é †åºï¼š

1. ğŸ“– **å…ˆè®€** `openapi-phase1.json` - äº†è§£ API å½¢ç‹€
2. ğŸ“ **å†çœ‹** `lib/api.types.ts` - ç­è§£å‹åˆ¥çµæ§‹
3. ğŸª **æ¸¬è©¦** `lib/hooks/useAPI.ts` - ç†è§£å‰ç«¯æ•´åˆ
4. ğŸ”§ **å¯¦åš** `routes/routes.ts` - å¯¦ç¾å¾Œç«¯é‚è¼¯
5. ğŸ“š **é©—è­‰** `API_USAGE_EXAMPLES.md` - å®Œæ•´æµç¨‹ç¯„ä¾‹

---

**å¦‚æœ‰å•é¡Œï¼Œè«‹åƒè€ƒ `DEVELOPMENT_GUIDE.ts` ä¸­çš„æ•…éšœæ’é™¤ç« ç¯€ã€‚** ğŸš€
